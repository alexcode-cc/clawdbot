# 擴充套件開發

## 概述

Moltbot 擴充套件（插件）是獨立的模組，可新增頻道、工具、CLI 命令等功能。本文件說明如何開發和發布擴充套件。

## 擴充套件結構

### 目錄結構

```
extensions/<plugin-id>/
├── clawdbot.plugin.json    # 插件元資料
├── index.ts                # 入口檔案
├── package.json            # 依賴管理
├── README.md               # 說明文件
├── CHANGELOG.md            # 變更記錄
└── src/                    # 原始碼
    ├── channel.ts          # 頻道實作（如適用）
    ├── runtime.ts          # 運行時設定
    ├── monitor.ts          # 訊息監控
    ├── send.ts             # 發送邏輯
    ├── onboarding.ts       # 引導流程
    ├── tool.ts             # 工具實作（如適用）
    └── types.ts            # 類型定義
```

### 元資料檔案

```json
// clawdbot.plugin.json
{
  "id": "my-plugin",
  "name": "My Plugin",
  "version": "1.0.0",
  "description": "A custom plugin for Moltbot",
  
  // 頻道擴充
  "channels": ["my-channel"],
  
  // 提供者擴充
  "providers": ["my-provider"],
  
  // 特殊類型
  "kind": "channel",  // channel | memory | tool | provider
  
  // 配置模式
  "configSchema": {
    "type": "object",
    "properties": {
      "apiKey": {
        "type": "string",
        "description": "API Key for the service"
      },
      "enabled": {
        "type": "boolean",
        "default": true
      }
    },
    "required": ["apiKey"]
  }
}
```

### 入口檔案

```typescript
// index.ts
import type { MoltbotPluginApi, MoltbotPlugin } from 'clawdbot/plugin-sdk';
import { emptyPluginConfigSchema } from 'clawdbot/plugin-sdk';
import { channelPlugin } from './src/channel.js';
import { setRuntime } from './src/runtime.js';

const plugin: MoltbotPlugin = {
  id: 'my-plugin',
  name: 'My Plugin',
  description: 'A custom plugin',
  configSchema: emptyPluginConfigSchema(),
  
  register(api: MoltbotPluginApi) {
    // 設定運行時
    setRuntime(api.runtime);
    
    // 註冊頻道
    api.registerChannel({ plugin: channelPlugin });
    
    // 註冊工具
    api.registerTool(myTool);
    
    // 註冊 CLI
    api.registerCli(registerMyCli);
    
    // 註冊 Gateway 方法
    api.registerGatewayMethod('my-plugin.action', myHandler);
    
    // 註冊 HTTP 處理器
    api.registerHttpHandler(webhookHandler);
    
    // 註冊服務
    api.registerService(myService);
  },
};

export default plugin;
```

## Plugin API

### MoltbotPluginApi

```typescript
interface MoltbotPluginApi {
  // 運行時存取
  runtime: PluginRuntime;
  config: PluginConfig;
  logger: Logger;
  
  // 註冊方法
  registerChannel(opts: ChannelRegistration): void;
  registerTool(tool: ToolDefinition, opts?: ToolOptions): void;
  registerGatewayMethod(name: string, handler: RpcHandler): void;
  registerHttpHandler(handler: HttpHandler): void;
  registerCli(registrar: CliRegistrar, opts?: CliOptions): void;
  registerService(service: ServiceDefinition): void;
  registerProvider(provider: ProviderDefinition): void;
}
```

### 運行時服務

```typescript
interface PluginRuntime {
  // TTS 服務
  tts: TTSService;
  
  // 工具系統
  tools: ToolRegistry;
  
  // 頻道管理
  channels: ChannelManager;
  
  // 配置存取
  getConfig<T>(key: string): T | undefined;
  setConfig<T>(key: string, value: T): void;
  
  // 事件發射
  emit(event: string, payload: unknown): void;
  on(event: string, handler: EventHandler): void;
}
```

## 註冊類型

### 頻道註冊

```typescript
api.registerChannel({
  plugin: {
    id: 'my-channel',
    name: 'My Channel',
    
    async initialize(config) {
      // 初始化連接
    },
    
    async startMonitor(handler) {
      // 監聽入站訊息
    },
    
    async sendMessage(chatId, message) {
      // 發送出站訊息
    },
    
    async getStatus() {
      return { connected: true };
    },
    
    async shutdown() {
      // 清理資源
    },
  },
  
  // 可選：Dock 配置
  dock: {
    icon: 'message-circle',
    color: '#007AFF',
  },
});
```

### 工具註冊

```typescript
import { Type } from '@sinclair/typebox';

api.registerTool(
  {
    name: 'my_tool',
    description: 'Execute a custom action',
    parameters: Type.Object({
      input: Type.String({ description: 'Input value' }),
      option: Type.Optional(Type.Boolean()),
    }),
    execute: async (toolCallId, params, context) => {
      const { input, option } = params;
      // 執行邏輯
      return { result: `Processed: ${input}` };
    },
  },
  {
    // 可選配置
    requireApproval: false,
    category: 'utility',
  }
);
```

### Gateway 方法註冊

```typescript
api.registerGatewayMethod(
  'my-plugin.action',
  async ({ params, respond, broadcast }) => {
    try {
      const result = await doSomething(params);
      respond(true, { result });
      
      // 可選：廣播事件
      broadcast('my-plugin.event', { data: result });
    } catch (error) {
      respond(false, { error: error.message });
    }
  }
);
```

### HTTP 處理器註冊

```typescript
api.registerHttpHandler({
  path: '/webhooks/my-plugin',
  method: 'POST',
  handler: async (req, res) => {
    const payload = req.body;
    
    // 處理 webhook
    await processWebhook(payload);
    
    res.json({ success: true });
  },
});
```

### CLI 命令註冊

```typescript
api.registerCli(
  ({ program }) => {
    const cmd = program
      .command('my-plugin')
      .description('My plugin commands');
    
    cmd
      .command('action')
      .description('Execute action')
      .option('-v, --verbose', 'Verbose output')
      .action(async (options) => {
        // 執行命令
      });
  },
  {
    commands: ['my-plugin'],
  }
);
```

### 服務註冊

```typescript
api.registerService({
  id: 'my-service',
  
  async start() {
    // 啟動服務
    await initializeService();
  },
  
  async stop() {
    // 停止服務
    await cleanupService();
  },
  
  async healthCheck() {
    return { healthy: true };
  },
});
```

## 配置管理

### 讀取配置

```typescript
// 從 api.config 讀取
const apiKey = api.config.get('apiKey');
const options = api.config.get('options', { default: {} });

// 從配置檔
// ~/.clawdbot/config.json5
{
  "plugins": {
    "entries": {
      "my-plugin": {
        "enabled": true,
        "config": {
          "apiKey": "xxx",
          "options": { ... }
        }
      }
    }
  }
}
```

### 配置驗證

使用 `configSchema` 定義配置模式：

```typescript
// clawdbot.plugin.json
{
  "configSchema": {
    "type": "object",
    "properties": {
      "apiKey": {
        "type": "string",
        "minLength": 10
      },
      "timeout": {
        "type": "number",
        "minimum": 1000,
        "default": 30000
      },
      "features": {
        "type": "object",
        "properties": {
          "featureA": { "type": "boolean" },
          "featureB": { "type": "boolean" }
        }
      }
    },
    "required": ["apiKey"]
  }
}
```

## 依賴管理

### package.json

```json
{
  "name": "@moltbot-plugins/my-plugin",
  "version": "1.0.0",
  "type": "module",
  "main": "index.ts",
  "dependencies": {
    "my-sdk": "^1.0.0"
  },
  "devDependencies": {
    "moltbot": "workspace:*"
  },
  "peerDependencies": {
    "moltbot": "*"
  }
}
```

### 重要注意事項

1. **不要在 dependencies 中使用 `workspace:*`** - npm install 會失敗
2. **將 moltbot 放在 devDependencies 或 peerDependencies**
3. **運行時依賴必須在 dependencies** - 安裝時只裝 dependencies

## 類型定義

### 使用 Plugin SDK 類型

```typescript
import type {
  MoltbotPlugin,
  MoltbotPluginApi,
  PluginRuntime,
  ChannelPlugin,
  ToolDefinition,
  RpcHandler,
} from 'clawdbot/plugin-sdk';
```

### 自訂類型

```typescript
// src/types.ts
export interface MyPluginConfig {
  apiKey: string;
  timeout?: number;
  features?: {
    featureA?: boolean;
    featureB?: boolean;
  };
}

export interface MyPluginMessage {
  id: string;
  content: string;
  sender: string;
  timestamp: Date;
}
```

## 測試

### 單元測試

```typescript
// src/channel.test.ts
import { describe, it, expect, vi } from 'vitest';
import { channelPlugin } from './channel.js';

describe('My Channel Plugin', () => {
  it('should initialize correctly', async () => {
    const config = { apiKey: 'test-key' };
    await channelPlugin.initialize(config);
    expect(channelPlugin.getStatus()).resolves.toMatchObject({
      connected: true,
    });
  });
  
  it('should send message', async () => {
    const result = await channelPlugin.sendMessage('chat-1', {
      content: 'Hello',
    });
    expect(result.success).toBe(true);
  });
});
```

### 執行測試

```bash
# 從專案根目錄
pnpm test extensions/my-plugin/

# 或在擴充套件目錄
cd extensions/my-plugin
pnpm test
```

## 發布

### 本地安裝

```bash
# 從 extensions 目錄安裝
moltbot plugins install ./extensions/my-plugin

# 或在配置中啟用
# ~/.clawdbot/config.json5
{
  "plugins": {
    "entries": {
      "my-plugin": {
        "enabled": true,
        "path": "~/path/to/my-plugin"
      }
    }
  }
}
```

### 發布到 npm

```bash
cd extensions/my-plugin
npm publish --access public
```

### 從 npm 安裝

```bash
moltbot plugins install @moltbot-plugins/my-plugin
```

## 範例擴充套件

### 簡單頻道擴充

```typescript
// extensions/simple-channel/index.ts
import type { MoltbotPluginApi } from 'clawdbot/plugin-sdk';

let client: SimpleClient;

const plugin = {
  id: 'simple-channel',
  name: 'Simple Channel',
  configSchema: {
    type: 'object',
    properties: {
      token: { type: 'string' },
    },
    required: ['token'],
  },
  
  register(api: MoltbotPluginApi) {
    api.registerChannel({
      plugin: {
        id: 'simple-channel',
        name: 'Simple Channel',
        
        async initialize(config) {
          client = new SimpleClient(config.token);
          await client.connect();
        },
        
        async startMonitor(handler) {
          client.on('message', (msg) => {
            handler({
              id: msg.id,
              channelId: 'simple-channel',
              chatId: msg.chat,
              senderId: msg.from,
              content: msg.text,
              timestamp: new Date(),
            });
          });
        },
        
        async sendMessage(chatId, message) {
          await client.send(chatId, message.content);
        },
        
        async getStatus() {
          return { connected: client.isConnected() };
        },
        
        async shutdown() {
          await client.disconnect();
        },
      },
    });
  },
};

export default plugin;
```

### 工具擴充

```typescript
// extensions/calculator/index.ts
import { Type } from '@sinclair/typebox';
import type { MoltbotPluginApi } from 'clawdbot/plugin-sdk';

const plugin = {
  id: 'calculator',
  name: 'Calculator Tool',
  
  register(api: MoltbotPluginApi) {
    api.registerTool({
      name: 'calculate',
      description: 'Perform mathematical calculations',
      parameters: Type.Object({
        expression: Type.String({
          description: 'Mathematical expression to evaluate',
        }),
      }),
      execute: async (toolCallId, params) => {
        const { expression } = params;
        try {
          // 安全的數學運算（實際應用中需更嚴格的處理）
          const result = eval(expression);
          return { result: String(result) };
        } catch (error) {
          return { error: 'Invalid expression' };
        }
      },
    });
  },
};

export default plugin;
```

## 最佳實踐

1. **錯誤處理**: 妥善處理所有可能的錯誤情況
2. **日誌記錄**: 使用 `api.logger` 記錄重要操作
3. **配置驗證**: 定義完整的 configSchema
4. **資源清理**: 在 shutdown 時清理所有資源
5. **類型安全**: 使用 TypeScript 和 TypeBox
6. **文件齊全**: 提供 README 和 CHANGELOG
7. **測試覆蓋**: 撰寫單元測試和整合測試
