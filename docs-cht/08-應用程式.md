# 原生應用程式

## 概述

Moltbot 提供 iOS、Android、macOS 三個原生應用程式，都透過 WebSocket 連接 Gateway 伺服器進行通訊。

## 應用程式架構

```
                    ┌─────────────────────────────────────┐
                    │            Gateway                  │
                    │         (WebSocket Server)          │
                    └─────────────────────────────────────┘
                         ▲              ▲              ▲
                         │              │              │
              WebSocket  │   WebSocket  │   WebSocket  │
                         │              │              │
               ┌─────────┴───┐   ┌──────┴──────┐   ┌───┴─────────┐
               │   macOS     │   │    iOS      │   │   Android   │
               │    App      │   │    App      │   │     App     │
               │             │   │             │   │             │
               │ - Menu Bar  │   │ - Node Mode │   │ - Node Mode │
               │ - Local GW  │   │ - Camera    │   │ - Camera    │
               │ - Chat UI   │   │ - Voice     │   │ - SMS       │
               │ - Canvas    │   │ - Location  │   │ - Screen    │
               └─────────────┘   └─────────────┘   └─────────────┘
```

## iOS 應用

### 目錄結構

```
apps/ios/
├── project.yml              # XcodeGen 專案定義
├── Moltbot.xcodeproj/       # Xcode 專案（生成）
├── Sources/                 # 原始碼
│   ├── ClawdbotApp.swift    # 應用程式入口
│   ├── RootTabs.swift       # 主要 TabView
│   ├── Model/               # 資料模型
│   │   └── NodeAppModel.swift
│   ├── Gateway/             # Gateway 連接
│   │   ├── GatewayConnectionController.swift
│   │   └── GatewayDiscoveryModel.swift
│   ├── Screens/             # UI 畫面
│   ├── Components/          # UI 元件
│   └── Utils/               # 工具函數
└── Tests/                   # 測試
```

### 主要功能

| 功能 | 說明 |
|------|------|
| Node Mode | 作為節點連接 Gateway，提供裝置能力 |
| Camera | 拍照並傳送給 AI |
| Voice Wake | 語音喚醒功能 |
| Location | 提供位置資訊 |
| Canvas | WebView 顯示 A2UI |

### 狀態管理

```swift
// 使用 Observation 框架
@Observable
class NodeAppModel {
    var connectionState: ConnectionState = .disconnected
    var gatewayUrl: String?
    var capabilities: NodeCapabilities
    
    func connect() async {
        // 連接 Gateway
    }
    
    func handleInvoke(_ request: NodeInvokeRequest) async -> NodeInvokeResult {
        // 處理節點呼叫
    }
}
```

### Gateway 連接

```swift
// GatewayConnectionController.swift
class GatewayConnectionController {
    private var webSocket: URLSessionWebSocketTask?
    
    func connect(to url: URL, token: String) async throws {
        let request = URLRequest(url: url)
        webSocket = URLSession.shared.webSocketTask(with: request)
        webSocket?.resume()
        
        // 發送連接請求
        try await send(ConnectRequest(
            role: .node,
            token: token,
            capabilities: deviceCapabilities
        ))
        
        // 開始接收訊息
        receiveMessages()
    }
}
```

### 建置與執行

```bash
# 生成 Xcode 專案
cd apps/ios
xcodegen generate

# 開啟專案
open Moltbot.xcodeproj

# 建置（命令列）
pnpm ios:build

# 執行（模擬器）
pnpm ios:run
```

## Android 應用

### 目錄結構

```
apps/android/
├── app/
│   ├── build.gradle.kts         # 應用程式建置配置
│   └── src/main/
│       ├── AndroidManifest.xml  # 清單檔
│       ├── java/bot/molt/android/
│       │   ├── MainActivity.kt  # 主 Activity
│       │   ├── MainViewModel.kt # ViewModel
│       │   ├── NodeRuntime.kt   # 節點運行時
│       │   ├── gateway/         # Gateway 連接
│       │   │   ├── GatewaySession.kt
│       │   │   └── GatewayDiscovery.kt
│       │   ├── ui/              # Compose UI
│       │   └── capabilities/    # 裝置能力
│       └── res/                 # 資源檔
├── build.gradle.kts             # 根建置配置
└── settings.gradle.kts          # 設定
```

### 主要功能

| 功能 | 說明 |
|------|------|
| Node Mode | 作為節點連接 Gateway |
| Camera | 拍照功能 |
| Screen Recording | 螢幕錄製 |
| SMS | 簡訊存取（需權限） |
| Voice | 語音輸入 |
| Location | 位置服務 |

### 狀態管理

```kotlin
// MainViewModel.kt
class MainViewModel : ViewModel() {
    private val nodeRuntime = NodeRuntime()
    
    val connectionState = nodeRuntime.connectionState
    val messages = nodeRuntime.messages
    
    fun connect(gatewayUrl: String, token: String) {
        viewModelScope.launch {
            nodeRuntime.connect(gatewayUrl, token)
        }
    }
}

// NodeRuntime.kt
class NodeRuntime {
    private val _connectionState = MutableStateFlow<ConnectionState>(Disconnected)
    val connectionState: StateFlow<ConnectionState> = _connectionState
    
    private val session = GatewaySession()
    
    suspend fun connect(url: String, token: String) {
        _connectionState.value = Connecting
        session.connect(url, token)
        _connectionState.value = Connected
    }
}
```

### Gateway 連接

```kotlin
// GatewaySession.kt
class GatewaySession {
    private var webSocket: WebSocket? = null
    private val client = OkHttpClient()
    
    suspend fun connect(url: String, token: String) {
        val request = Request.Builder()
            .url(url)
            .build()
            
        webSocket = client.newWebSocket(request, object : WebSocketListener() {
            override fun onOpen(webSocket: WebSocket, response: Response) {
                // 發送連接請求
                sendConnect(token)
            }
            
            override fun onMessage(webSocket: WebSocket, text: String) {
                handleMessage(text)
            }
        })
    }
}
```

### 建置與執行

```bash
# 建置 Debug APK
pnpm android:assemble

# 安裝到裝置
pnpm android:install

# 建置並執行
pnpm android:run

# 執行測試
pnpm android:test
```

## macOS 應用

### 目錄結構

```
apps/macos/
├── Sources/Moltbot/
│   ├── MenuBar.swift            # 選單列入口 (@main)
│   ├── AppState.swift           # 應用程式狀態
│   ├── ControlChannel.swift     # 控制頻道
│   ├── GatewayProcessManager.swift  # Gateway 程序管理
│   ├── Views/                   # SwiftUI 視圖
│   │   ├── ChatView.swift
│   │   ├── SettingsView.swift
│   │   └── CanvasWindow.swift
│   ├── Node/                    # 節點功能
│   │   └── MacNodeModeCoordinator.swift
│   └── Resources/
│       └── Info.plist
├── Package.swift                # Swift Package 定義
└── Tests/                       # 測試
```

### 主要功能

| 功能 | 說明 |
|------|------|
| Menu Bar | 選單列常駐應用 |
| Local Gateway | 運行本地 Gateway |
| Remote Gateway | 連接遠端 Gateway |
| Chat UI | 聊天介面 |
| Canvas | A2UI 視窗 |
| Voice Wake | 語音喚醒 |
| Node Mode | 同時作為節點 |

### 應用程式狀態

```swift
// AppState.swift
@Observable
class AppState {
    // 連接模式
    enum ConnectionMode {
        case local
        case remote(url: String)
    }
    
    var connectionMode: ConnectionMode = .local
    var isGatewayRunning = false
    var controlChannel: ControlChannel?
    
    // 設定
    var settings: AppSettings
    
    // 聊天狀態
    var currentSession: ChatSession?
    var messages: [ChatMessage] = []
    
    func startLocalGateway() async throws {
        try await GatewayProcessManager.shared.start()
        isGatewayRunning = true
    }
    
    func connectRemote(url: String) async throws {
        connectionMode = .remote(url: url)
        controlChannel = try await ControlChannel(url: url)
    }
}
```

### Gateway 程序管理

```swift
// GatewayProcessManager.swift
class GatewayProcessManager {
    static let shared = GatewayProcessManager()
    
    private var process: Process?
    
    func start() async throws {
        let process = Process()
        process.executableURL = moltbotBinaryURL
        process.arguments = ["gateway", "run", "--port", "18789"]
        
        try process.run()
        self.process = process
        
        // 等待 Gateway 就緒
        try await waitForReady()
    }
    
    func stop() {
        process?.terminate()
        process = nil
    }
}
```

### 建置與執行

```bash
# 打包應用程式
pnpm mac:package

# 開啟應用程式
pnpm mac:open

# 重啟（開發用）
pnpm mac:restart
```

## 共享程式碼

### MoltbotKit

```
apps/shared/MoltbotKit/
├── Sources/MoltbotKit/
│   ├── GatewayChannel.swift     # Gateway 通訊
│   ├── TalkMode.swift           # 對話模式
│   ├── CanvasHost.swift         # Canvas 主機
│   └── SystemCommands.swift     # 系統命令
├── Sources/MoltbotProtocol/
│   ├── GatewayModels.swift      # 協議模型
│   └── Messages.swift           # 訊息類型
└── Sources/MoltbotChatUI/
    ├── ChatView.swift           # 聊天視圖
    └── MessageBubble.swift      # 訊息泡泡
```

### 協議模型

```swift
// GatewayModels.swift（自動生成）
struct ConnectRequest: Codable {
    let role: NodeRole
    let token: String?
    let capabilities: NodeCapabilities?
    let commands: [NodeCommand]?
}

struct NodeInvokeRequest: Codable {
    let id: String
    let command: String
    let params: [String: AnyCodable]?
}

enum NodeRole: String, Codable {
    case control
    case node
    case chat
}
```

## Gateway 通訊協議

### 連接流程

```
App                                 Gateway
 │                                     │
 │──── WebSocket Connect ─────────────▶│
 │                                     │
 │──── { method: "connect",            │
 │       params: {                     │
 │         role: "node",               │
 │         token: "...",               │
 │         capabilities: {...},        │
 │         commands: [...]             │
 │       }                             │
 │     } ─────────────────────────────▶│
 │                                     │
 │◀─── { success: true,                │
 │       result: {                     │
 │         sessionId: "...",           │
 │         serverVersion: "..."        │
 │       }                             │
 │     } ──────────────────────────────│
 │                                     │
 │◀════ Events ════════════════════════│
 │                                     │
```

### 節點呼叫

```
Gateway                             App (Node)
   │                                   │
   │──── { method: "node.invoke.request",
   │       params: {
   │         id: "req-123",
   │         command: "camera.capture",
   │         params: { ... }
   │       }
   │     } ───────────────────────────▶│
   │                                   │
   │                              執行命令
   │                                   │
   │◀─── { method: "node.invoke.result",
   │       params: {
   │         id: "req-123",
   │         success: true,
   │         result: { imageUrl: "..." }
   │       }
   │     } ────────────────────────────│
   │                                   │
```

## 裝置能力

### iOS 能力

```swift
struct NodeCapabilities: Codable {
    var camera: Bool = true
    var microphone: Bool = true
    var location: Bool = true
    var screenshot: Bool = false  // iOS 限制
    var tts: Bool = true
}
```

### Android 能力

```kotlin
data class NodeCapabilities(
    val camera: Boolean = true,
    val microphone: Boolean = true,
    val location: Boolean = true,
    val screenshot: Boolean = true,
    val screenRecording: Boolean = true,
    val sms: Boolean = true,  // 需要權限
    val tts: Boolean = true
)
```

### macOS 能力

```swift
struct NodeCapabilities: Codable {
    var camera: Bool = true
    var microphone: Bool = true
    var screenshot: Bool = true
    var tts: Bool = true
    var exec: Bool = true  // 可執行命令
}
```

## 開發指南

### 協議同步

當修改協議時，需要重新生成 Swift 模型：

```bash
# 生成 TypeScript 協議
pnpm protocol:gen

# 生成 Swift 模型
pnpm protocol:gen:swift

# 檢查協議一致性
pnpm protocol:check
```

### SwiftUI 最佳實踐

```swift
// 使用 Observation 框架（推薦）
@Observable
class MyModel {
    var value: String = ""
}

// 而非 ObservableObject
class MyModel: ObservableObject {  // 不推薦
    @Published var value: String = ""
}
```

### 測試

```bash
# iOS 測試
cd apps/ios && xcodebuild test ...

# Android 測試
pnpm android:test

# macOS 測試
cd apps/macos && swift test
```
