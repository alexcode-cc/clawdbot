# 通訊頻道

## 概述

Moltbot 支援多種訊息平台，讓使用者能透過熟悉的聊天介面與 AI 互動。頻道分為內建頻道和擴充頻道兩類。

## 頻道架構

```
                    ┌─────────────────────────────────────┐
                    │          Channel Router             │
                    │                                     │
 WhatsApp ─────────▶│  ┌──────────────────────────────┐  │
 Telegram ─────────▶│  │     Inbound Handler          │  │
 Discord ──────────▶│  │  - 訊息解析                   │  │
 Slack ────────────▶│  │  - 路由檢查                   │  │
 Signal ───────────▶│  │  - allowlist 驗證             │  │
 iMessage ─────────▶│  └──────────────────────────────┘  │
                    │              │                      │
 (Extensions)       │              ▼                      │
 Matrix ───────────▶│  ┌──────────────────────────────┐  │
 MS Teams ─────────▶│  │     Message Queue            │  │
 Zalo ─────────────▶│  │  - 排隊處理                   │  │
 LINE ─────────────▶│  │  - 併發控制                   │  │
                    │  └──────────────────────────────┘  │
                    │              │                      │
                    │              ▼                      │
                    │  ┌──────────────────────────────┐  │
                    │  │     Agent Processor          │  │◀─── Gateway
                    │  │  - LLM 呼叫                   │  │
                    │  │  - 工具執行                   │  │
                    │  └──────────────────────────────┘  │
                    │              │                      │
                    │              ▼                      │
                    │  ┌──────────────────────────────┐  │
                    │  │     Outbound Handler         │  │
                    │  │  - 格式轉換                   │  │
                    │  │  - 發送訊息                   │  │
                    │  └──────────────────────────────┘  │
                    │                                     │
                    └─────────────────────────────────────┘
```

## 內建頻道

### WhatsApp (Baileys)

**技術**: Baileys（WhatsApp Web 協議）

**特色**:
- 掃描 QR Code 登入
- 支援私訊和群組
- 媒體訊息（圖片、音訊、文件）
- 即時狀態（輸入中、已讀）

**配置**:
```json5
{
  "channels": {
    "whatsapp": {
      "enabled": true,
      "allowlist": ["+1234567890"]
    }
  }
}
```

**程式碼位置**: `src/web/`

### Telegram

**技術**: grammY（Telegram Bot API）

**特色**:
- Bot API（需要 Bot Token）
- 支援私訊和群組
- 豐富的訊息格式（Markdown、按鈕）
- Webhook 或 Polling 模式

**配置**:
```json5
{
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "BOT_TOKEN",
      "allowlist": ["@username", "123456789"]
    }
  }
}
```

**程式碼位置**: `src/telegram/`

### Discord

**技術**: discord.js / Carbon

**特色**:
- Bot API（需要 Bot Token）
- 支援 DM 和伺服器頻道
- 斜線命令
- 訊息附件

**配置**:
```json5
{
  "channels": {
    "discord": {
      "enabled": true,
      "token": "BOT_TOKEN",
      "allowlist": ["user#1234", "server_id"]
    }
  }
}
```

**程式碼位置**: `src/discord/`

### Slack

**技術**: @slack/bolt

**特色**:
- Slack App（需要 OAuth Token）
- 支援 DM 和頻道
- 互動式元件
- Webhook 模式

**配置**:
```json5
{
  "channels": {
    "slack": {
      "enabled": true,
      "token": "xoxb-...",
      "signingSecret": "...",
      "appToken": "xapp-..."
    }
  }
}
```

**程式碼位置**: `src/slack/`

### Signal

**技術**: Signal 協議

**特色**:
- 端對端加密
- 私訊支援
- 需要 Signal CLI 或 signal-cli-rest-api

**配置**:
```json5
{
  "channels": {
    "signal": {
      "enabled": true,
      "number": "+1234567890"
    }
  }
}
```

**程式碼位置**: `src/signal/`

### iMessage

**技術**: imsg CLI（macOS 限定）

**特色**:
- macOS 原生整合
- 私訊和群組
- 需要 Full Disk Access

**配置**:
```json5
{
  "channels": {
    "imessage": {
      "enabled": true,
      "allowlist": ["+1234567890", "user@icloud.com"]
    }
  }
}
```

**程式碼位置**: `src/imessage/`

## 擴充頻道

### Matrix

**技術**: matrix-js-sdk

**特色**:
- 開放協議
- 端對端加密支援
- 多伺服器聯邦

**配置**:
```json5
{
  "plugins": {
    "entries": {
      "matrix": {
        "enabled": true,
        "config": {
          "homeserver": "https://matrix.org",
          "userId": "@bot:matrix.org",
          "accessToken": "..."
        }
      }
    }
  }
}
```

**程式碼位置**: `extensions/matrix/`

### Microsoft Teams

**技術**: Bot Framework

**特色**:
- 企業整合
- Teams Bot API
- 多租戶支援

**配置**:
```json5
{
  "plugins": {
    "entries": {
      "msteams": {
        "enabled": true,
        "config": {
          "appId": "...",
          "appPassword": "..."
        }
      }
    }
  }
}
```

**程式碼位置**: `extensions/msteams/`

### Zalo

**技術**: Zalo API

**特色**:
- 越南市場主流
- Bot API 和 User API
- OA 官方帳號

**配置**:
```json5
{
  "plugins": {
    "entries": {
      "zalo": {
        "enabled": true,
        "config": {
          "appId": "...",
          "secretKey": "..."
        }
      }
    }
  }
}
```

**程式碼位置**: `extensions/zalo/`, `extensions/zalouser/`

### LINE

**技術**: LINE Messaging API

**特色**:
- 日本/台灣市場主流
- 豐富的訊息模板
- Webhook 模式

**配置**:
```json5
{
  "plugins": {
    "entries": {
      "line": {
        "enabled": true,
        "config": {
          "channelAccessToken": "...",
          "channelSecret": "..."
        }
      }
    }
  }
}
```

**程式碼位置**: `extensions/line/`

### 飛書 (Feishu/Lark)（新增）

**技術**: @larksuiteoapi/node-sdk

**特色**:
- 飛書 Bot API
- 支援私訊和群組
- 整合飛書文件 (Docs)、表格 (Bitable)、雲端硬碟
- 動態 Agent 功能
- Webhook 模式

**配置**:
```json5
{
  plugins: {
    entries: {
      feishu: {
        enabled: true,
        config: {
          appId: "cli_xxxxx",
          appSecret: "xxxxx"
        }
      }
    }
  }
}
```

**程式碼位置**: `extensions/feishu/`

### 其他擴充頻道

| 頻道 | 說明 | 位置 |
|------|------|------|
| Mattermost | 開源團隊協作 | `extensions/mattermost/` |
| Nextcloud Talk | Nextcloud 整合 | `extensions/nextcloud-talk/` |
| Twitch | 直播聊天 | `extensions/twitch/` |
| Nostr | 去中心化協議 | `extensions/nostr/` |
| Google Chat | Google Workspace | `extensions/googlechat/` |
| BlueBubbles | iMessage 橋接 | `extensions/bluebubbles/` |
| Tlon (Urbit) | Urbit 網路 | `extensions/tlon/` |

## 頻道通用介面

### Channel 插件結構

```typescript
// extensions/*/src/channel.ts
export const channelPlugin: ChannelPlugin = {
  id: 'my-channel',
  name: 'My Channel',
  
  // 初始化
  async initialize(config: ChannelConfig) {
    // 建立連接
  },
  
  // 監聽訊息
  async startMonitor(handler: MessageHandler) {
    // 設定訊息監聽器
  },
  
  // 發送訊息
  async sendMessage(chatId: string, message: OutgoingMessage) {
    // 發送訊息到平台
  },
  
  // 取得狀態
  async getStatus(): Promise<ChannelStatus> {
    return { connected: true, ... };
  },
  
  // 關閉
  async shutdown() {
    // 清理資源
  },
};
```

### 訊息格式

```typescript
// 入站訊息
interface IncomingMessage {
  id: string;
  channelId: string;
  chatId: string;
  senderId: string;
  senderName?: string;
  content: string;
  attachments?: Attachment[];
  replyTo?: string;
  timestamp: Date;
}

// 出站訊息
interface OutgoingMessage {
  content: string;
  format?: 'text' | 'markdown' | 'html';
  attachments?: Attachment[];
  replyTo?: string;
  buttons?: Button[];
}

// 附件
interface Attachment {
  type: 'image' | 'audio' | 'video' | 'file';
  url?: string;
  data?: Buffer;
  mimeType?: string;
  filename?: string;
}
```

## 訊息路由

### Allowlist 機制

```typescript
// 配置
{
  "channels": {
    "telegram": {
      "allowlist": ["@user1", "@user2", "group_id"]
    }
  }
}

// 路由檢查
function isAllowed(message: IncomingMessage, config: ChannelConfig): boolean {
  if (!config.allowlist || config.allowlist.length === 0) {
    return true; // 無限制
  }
  return config.allowlist.includes(message.senderId) ||
         config.allowlist.includes(message.chatId);
}
```

### 路由規則

```typescript
// 配置
{
  "routing": {
    "rules": [
      {
        "match": { "channel": "telegram", "chat": "@admin" },
        "agent": "admin-agent"
      },
      {
        "match": { "channel": "*", "pattern": "^/code" },
        "agent": "code-agent"
      }
    ],
    "default": "default-agent"
  }
}
```

## 頻道狀態

### 狀態類型

```typescript
interface ChannelStatus {
  id: string;
  name: string;
  connected: boolean;
  authenticated: boolean;
  lastActivity?: Date;
  error?: string;
  metadata?: Record<string, unknown>;
}
```

### 查詢狀態

```bash
# 基本狀態
moltbot channels status

# 深度探測
moltbot channels status --deep

# 特定頻道
moltbot channels status telegram
```

## 頻道操作

### 連接頻道

```bash
# 連接 Telegram
moltbot channels connect telegram

# 連接 WhatsApp（會顯示 QR Code）
moltbot channels connect whatsapp
```

### 發送訊息

```bash
# CLI 發送
moltbot message send --channel telegram --chat @user "Hello"

# 透過 Gateway API
ws.send(JSON.stringify({
  method: 'channels.send',
  params: {
    channel: 'telegram',
    chatId: '@user',
    message: { content: 'Hello' }
  }
}));
```

## 開發新頻道

### 1. 建立擴充套件目錄

```
extensions/my-channel/
├── clawdbot.plugin.json
├── index.ts
├── package.json
└── src/
    ├── channel.ts
    ├── monitor.ts
    ├── send.ts
    └── runtime.ts
```

### 2. 定義插件元資料

```json
// clawdbot.plugin.json
{
  "id": "my-channel",
  "channels": ["my-channel"],
  "configSchema": {
    "type": "object",
    "properties": {
      "apiKey": { "type": "string" },
      "allowlist": { "type": "array", "items": { "type": "string" } }
    },
    "required": ["apiKey"]
  }
}
```

### 3. 實作頻道插件

```typescript
// src/channel.ts
import type { ChannelPlugin, MessageHandler } from 'clawdbot/plugin-sdk';

export const channelPlugin: ChannelPlugin = {
  id: 'my-channel',
  name: 'My Channel',
  
  async initialize(config) {
    // 初始化 SDK
  },
  
  async startMonitor(handler: MessageHandler) {
    // 設定訊息監聽
    client.on('message', (msg) => {
      handler({
        id: msg.id,
        channelId: 'my-channel',
        chatId: msg.chatId,
        senderId: msg.sender,
        content: msg.text,
        timestamp: new Date(),
      });
    });
  },
  
  async sendMessage(chatId, message) {
    await client.send(chatId, message.content);
  },
  
  async getStatus() {
    return { connected: client.isConnected() };
  },
};
```

### 4. 註冊插件

```typescript
// index.ts
import type { MoltbotPluginApi } from 'clawdbot/plugin-sdk';
import { channelPlugin } from './src/channel.js';

const plugin = {
  id: 'my-channel',
  name: 'My Channel',
  register(api: MoltbotPluginApi) {
    api.registerChannel({ plugin: channelPlugin });
  },
};

export default plugin;
```

## 最佳實踐

1. **錯誤處理**: 妥善處理網路錯誤和 API 限制
2. **重連機制**: 實作自動重連和指數退避
3. **速率限制**: 遵守平台 API 限制
4. **日誌記錄**: 記錄關鍵操作便於除錯
5. **安全性**: 妥善保管認證憑證
