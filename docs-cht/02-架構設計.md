# Moltbot 架構設計

## 整體架構

Moltbot 採用分層架構設計，各層之間透過明確的介面進行通訊：

```
┌─────────────────────────────────────────────────────────────┐
│                      應用層 (Applications)                    │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│   │ macOS   │  │  iOS    │  │ Android │  │ Web UI  │        │
│   │  App    │  │  App    │  │   App   │  │  (Lit)  │        │
│   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘        │
└────────┼────────────┼────────────┼────────────┼─────────────┘
         │            │            │            │
         └────────────┴──────┬─────┴────────────┘
                             │ WebSocket
┌────────────────────────────┼────────────────────────────────┐
│                    Gateway 層 (Server)                       │
│   ┌────────────────────────┴────────────────────────┐       │
│   │              Gateway Server                      │       │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────────────┐ │       │
│   │  │ RPC 方法 │ │ 會話管理 │ │ 事件廣播        │ │       │
│   │  └──────────┘ └──────────┘ └──────────────────┘ │       │
│   └──────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────┘
         │
┌────────┼────────────────────────────────────────────────────┐
│        │               核心層 (Core)                         │
│   ┌────┴────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│   │ Agent   │  │ Channels │  │  Config  │  │  Infra   │    │
│   │ System  │  │ (通道)   │  │  (配置)  │  │(基礎設施)│    │
│   └─────────┘  └──────────┘  └──────────┘  └──────────┘    │
└─────────────────────────────────────────────────────────────┘
         │
┌────────┼────────────────────────────────────────────────────┐
│        │              CLI 層 (Commands)                      │
│   ┌────┴────┐                                                │
│   │ CLI     │  ┌──────────────────────────────────────────┐ │
│   │ Program │──│ setup, config, agent, message, gateway...│ │
│   └─────────┘  └──────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
         │
┌────────┼────────────────────────────────────────────────────┐
│        │            擴充層 (Extensions)                      │
│   ┌────┴────────────────────────────────────────────┐       │
│   │ Plugin Registry                                  │       │
│   │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │       │
│   │  │ Matrix │ │ Teams  │ │  Zalo  │ │ Twitch │ ...│       │
│   │  └────────┘ └────────┘ └────────┘ └────────┘   │       │
│   └──────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 模組組織

### 原始碼結構 (`src/`)

```
src/
├── entry.ts                 # CLI 入口點
├── index.ts                 # 模組匯出
│
├── cli/                     # CLI 框架 (169 檔案)
│   ├── run-main.ts          # 主執行邏輯
│   ├── deps.ts              # 依賴注入定義
│   ├── program/             # Commander.js 程式建構
│   │   ├── build-program.ts # 程式建構器
│   │   ├── command-registry.ts # 命令註冊表
│   │   └── register.*.ts    # 命令註冊器
│   └── progress.ts          # 進度顯示
│
├── commands/                # 命令實作 (223 檔案)
│   ├── setup/               # 設定精靈
│   ├── config/              # 配置管理
│   ├── agent/               # Agent 命令
│   ├── message/             # 訊息操作
│   └── ...
│
├── agents/                  # Agent 核心 (436 檔案)
│   ├── agent-scope.ts       # Agent 配置解析
│   ├── system-prompt.ts     # 系統提示詞建構
│   ├── moltbot-tools.ts     # 核心工具建立
│   ├── pi-embedded-runner/  # Pi Agent 執行器
│   └── workspace.ts         # 工作區管理
│
├── gateway/                 # Gateway 伺服器 (187 檔案)
│   ├── server.impl.ts       # 伺服器實作
│   ├── server-runtime-state.ts # 運行時狀態
│   ├── server-methods.ts    # RPC 方法
│   └── protocol/            # 協議定義
│
├── config/                  # 配置系統 (130 檔案)
│   ├── io.ts                # 配置 I/O
│   ├── validation.ts        # 驗證邏輯
│   └── zod-schema.ts        # Zod Schema
│
├── channels/                # 共用頻道邏輯
├── telegram/                # Telegram 實作
├── discord/                 # Discord 實作
├── slack/                   # Slack 實作
├── signal/                  # Signal 實作
├── imessage/                # iMessage 實作
├── web/                     # WhatsApp (Baileys)
│
├── infra/                   # 基礎設施
│   ├── outbound/            # 訊息發送
│   ├── provider-usage.*     # 使用量追蹤
│   ├── exec-*               # 執行安全
│   ├── session-maintenance-warning.ts # 會話維護警告
│   └── update-*             # 更新機制
│
├── security/                # 安全模組（已重構拆分）
│   ├── audit-extra.sync.ts  # 同步安全審計
│   ├── audit-extra.async.ts # 非同步安全審計
│   └── skill-scanner.ts     # 技能/插件安全掃描
│
├── cron/                    # 排程任務
│   ├── service/             # Cron 服務
│   └── session-reaper.ts    # 會話自動清理
│
├── plugins/                 # 插件系統
│   ├── source-display.ts    # 插件來源顯示
│   └── ...
├── plugin-sdk/              # 插件開發 SDK（已擴充設備配對 API）
├── sessions/                # 會話管理（新增自動維護）
├── memory/                  # 記憶系統（QMD 後端改進）
├── media/                   # 媒體處理
├── tts/                     # 文字轉語音
├── browser/                 # 瀏覽器控制
├── utils/                   # 共用工具（新增）
│   ├── fetch-timeout.ts     # 統一的 fetchWithTimeout
│   └── normalize-secret-input.ts
└── terminal/                # 終端工具
```

## 核心設計模式

### 1. 依賴注入模式

專案使用多種依賴注入方式，確保模組可測試和可替換：

#### 函數式 DI（CLI 層）

```typescript
// src/cli/deps.ts
export type CliDeps = {
  sendMessageWhatsApp: typeof sendMessageWhatsApp;
  sendMessageTelegram: typeof sendMessageTelegram;
  sendMessageDiscord: typeof sendMessageDiscord;
  // ... 更多依賴
};

export function createDefaultDeps(): CliDeps {
  return {
    sendMessageWhatsApp,
    sendMessageTelegram,
    sendMessageDiscord,
    // ...
  };
}

// 使用方式
const deps = createDefaultDeps();
await deps.sendMessageTelegram(chatId, message);
```

#### 工廠函數 DI（Config 層）

```typescript
// src/config/io.ts
export type ConfigIoDeps = {
  fs?: typeof fsPromises;
  logger?: Logger;
  env?: Record<string, string | undefined>;
};

export function createConfigIO(overrides: ConfigIoDeps = {}) {
  const deps = {
    fs: overrides.fs ?? fsPromises,
    logger: overrides.logger ?? defaultLogger,
    env: overrides.env ?? process.env,
  };
  
  return {
    loadConfig: () => loadConfigImpl(deps),
    saveConfig: (config) => saveConfigImpl(deps, config),
  };
}
```

#### Options 物件 DI（Agent 層）

```typescript
// src/agents/moltbot-tools.ts
export interface MoltbotToolsOptions {
  sandboxBrowserBridgeUrl?: string;
  agentSessionKey?: string;
  workspaceDir?: string;
  // ...
}

export function createMoltbotTools(options?: MoltbotToolsOptions) {
  const opts = { ...defaultOptions, ...options };
  // 使用 opts 建立工具
}
```

### 2. 命令註冊模式

CLI 使用註冊表和懶加載機制管理命令：

```typescript
// src/cli/program/command-registry.ts
export interface CommandRegistration {
  name: string;
  aliases?: string[];
  description: string;
  register: (program: Command) => void | Promise<void>;
}

export const commandRegistry: CommandRegistration[] = [
  {
    name: 'setup',
    description: '設定精靈',
    register: registerSetup,
  },
  // ...
];

// 懶加載子命令
// src/cli/program/register.subclis.ts
export const lazySubClis = [
  { name: 'gateway', register: registerGatewaySubCli },
  { name: 'models', register: registerModelsSubCli },
  // ... 30+ 子命令
];
```

### 3. 插件系統模式

```typescript
// 插件定義
export interface MoltbotPlugin {
  id: string;
  name: string;
  description: string;
  configSchema: TSchema;
  register(api: MoltbotPluginApi): void;
}

// 插件 API
export interface MoltbotPluginApi {
  runtime: PluginRuntime;
  config: PluginConfig;
  logger: Logger;
  
  registerChannel(opts: ChannelRegistration): void;
  registerTool(tool: ToolDefinition): void;
  registerGatewayMethod(name: string, handler: RpcHandler): void;
  registerHttpHandler(handler: HttpHandler): void;
  registerCli(registrar: CliRegistrar): void;
  registerService(service: ServiceDefinition): void;
}
```

### 4. 事件驅動模式

Gateway 使用事件驅動架構進行即時通訊：

```typescript
// 廣播事件
broadcast(clients, {
  type: 'chat.message',
  payload: { sessionKey, content, role: 'assistant' },
});

// 訂閱事件
ws.on('message', (data) => {
  const { type, payload } = JSON.parse(data);
  switch (type) {
    case 'chat.send':
      handleChatSend(payload);
      break;
    // ...
  }
});
```

## 資料流

### 訊息處理流程

```
使用者訊息 (WhatsApp/Telegram/...)
        │
        ▼
┌───────────────────┐
│   Channel 監聽器   │  監聽訊息平台
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   訊息路由器       │  allowlist/routing 檢查
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   Gateway 佇列    │  排隊處理
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   Agent 執行器    │  LLM 推理 + 工具呼叫
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   回覆發送        │  透過對應頻道回覆
└───────────────────┘
```

### Gateway 連接流程

```
客戶端 (App/Web UI)
        │
        ▼
┌───────────────────┐
│  WebSocket 連接   │  ws://gateway:18789
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│    認證握手       │  Token + Device Identity
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   角色註冊        │  control/node/chat
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   雙向通訊        │  RPC 請求/回應 + 事件推送
└───────────────────┘
```

## 模組間依賴關係

```
CLI Layer ──────────────────────────────────────┐
    │                                            │
    ▼                                            │
Commands Layer ─────────────────────────────────┤
    │                                            │
    ▼                                            │ 垂直依賴
Core Modules (Agents, Gateway, Channels) ───────┤
    │                                            │
    ▼                                            │
Infra Layer ────────────────────────────────────┤
    │                                            │
    ▼                                            │
Config Layer ───────────────────────────────────┘


Extensions ─────────────────┐
    │                       │ 水平擴展
    ▼                       │
Plugin SDK ◄────────────────┘
    │
    ▼
Core Modules (透過 API 介面)
```

## 配置架構

```
~/.clawdbot/                     # 使用者配置目錄
├── config.json5                 # 主配置檔
├── credentials/                 # 認證憑證
├── sessions/                    # 會話儲存
├── agents/                      # Agent 工作區
│   └── <agentId>/
│       ├── workspace/           # 工作目錄
│       └── sessions/            # 對話紀錄
└── plugins/                     # 已安裝插件
```

## 安全考量

1. **執行沙箱**: 工具執行受限於特定目錄
2. **審批機制**: 敏感操作需使用者確認
3. **認證**: Gateway 支援 Token 和設備身份認證
4. **加密**: 支援 TLS (WSS) 和端對端加密頻道
5. **安全掃描器** (`src/security/skill-scanner.ts`): 自動掃描技能/插件程式碼
   - 偵測規則：危險執行 (child_process)、動態程式碼 (eval)、加密挖礦、可疑網路連線、資料外洩、程式碼混淆、環境變數蒐集
   - 嚴重等級：`critical`、`warn`、`info`
6. **命令授權分離**: `commands.allowFrom` 可獨立限制命令使用者
7. **Discord 元件安全**: Agent Components 強制 DM 授權檢查、防止頻道 ID 偽造
8. **會話自動維護**: 自動清理過期條目、限制儲存大小、檔案輪轉
