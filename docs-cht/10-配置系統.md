# 配置系統

## 概述

Moltbot 使用 JSON5 格式的配置檔案，支援環境變數替換、包含指令、Zod Schema 驗證等功能。

## 配置檔案位置

### 預設路徑

```
~/.clawdbot/config.json5
```

### 自訂路徑

```bash
# 環境變數
export CLAWDBOT_CONFIG_PATH=/path/to/config.json5

# 命令列參數
moltbot --config /path/to/config.json5
```

### 配置檔案（Profile）

```bash
# 使用 dev 檔案
export CLAWDBOT_PROFILE=dev
# 會載入 ~/.clawdbot/config.dev.json5

# 或命令列
moltbot --profile dev
```

## 配置結構

### 完整配置範例

```json5
{
  // 模型配置
  "models": {
    "default": "claude-sonnet",
    "entries": {
      "claude-sonnet": {
        "provider": "anthropic",
        "model": "claude-3-5-sonnet-latest"
      },
      "gpt-4o": {
        "provider": "openai",
        "model": "gpt-4o"
      },
      "local": {
        "provider": "ollama",
        "model": "llama3.2"
      }
    }
  },
  
  // 提供者配置
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}"
    },
    "openai": {
      "apiKey": "${OPENAI_API_KEY}"
    },
    "ollama": {
      "baseUrl": "http://localhost:11434"
    }
  },
  
  // Agent 配置
  "agents": {
    "default": {
      "id": "default",
      "name": "Moltbot",
      "model": "claude-sonnet",
      "workspace": "~/Projects",
      "identity": {
        "name": "Moltbot",
        "soul": "You are a helpful AI assistant."
      },
      "tools": {
        "exec": { "enabled": true },
        "browser": { "enabled": true }
      }
    }
  },
  
  // 頻道配置
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "${TELEGRAM_BOT_TOKEN}",
      "allowlist": ["@username"]
    },
    "whatsapp": {
      "enabled": true,
      "allowlist": ["+1234567890"]
    },
    "discord": {
      "enabled": true,
      "token": "${DISCORD_BOT_TOKEN}"
    }
  },
  
  // 插件配置
  "plugins": {
    "entries": {
      "matrix": {
        "enabled": true,
        "config": {
          "homeserver": "https://matrix.org",
          "userId": "@bot:matrix.org"
        }
      }
    }
  },
  
  // Gateway 配置
  "gateway": {
    "mode": "local",
    "port": 18789,
    "bind": "loopback",
    "token": "${GATEWAY_TOKEN}"
  },
  
  // 路由配置
  "routing": {
    "rules": [],
    "default": "default"
  },
  
  // 其他設定
  "timezone": "Asia/Taipei",
  "locale": "zh-TW"
}
```

## 配置區塊詳解

### models - 模型配置

```json5
{
  "models": {
    // 預設模型 ID
    "default": "claude-sonnet",
    
    // 模型定義
    "entries": {
      "claude-sonnet": {
        "provider": "anthropic",        // 提供者 ID
        "model": "claude-3-5-sonnet-latest",  // 模型名稱
        "maxTokens": 8192,              // 最大輸出 token
        "temperature": 0.7              // 溫度參數
      },
      "claude-opus": {
        "provider": "anthropic",
        "model": "claude-3-opus-latest"
      },
      "gpt-4o": {
        "provider": "openai",
        "model": "gpt-4o"
      },
      "local-llama": {
        "provider": "ollama",
        "model": "llama3.2"
      }
    }
  }
}
```

### providers - 提供者配置

```json5
{
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}",
      "baseUrl": "https://api.anthropic.com"  // 可選
    },
    "openai": {
      "apiKey": "${OPENAI_API_KEY}",
      "baseUrl": "https://api.openai.com/v1"  // 可選
    },
    "ollama": {
      "baseUrl": "http://localhost:11434"
    },
    "openrouter": {
      "apiKey": "${OPENROUTER_API_KEY}"
    },
    "bedrock": {
      "region": "us-east-1",
      "accessKeyId": "${AWS_ACCESS_KEY_ID}",
      "secretAccessKey": "${AWS_SECRET_ACCESS_KEY}"
    }
  }
}
```

### agents - Agent 配置

```json5
{
  "agents": {
    "default": {
      "id": "default",
      "name": "Moltbot",
      "model": "claude-sonnet",
      "workspace": "~/Projects",
      
      // 身份設定
      "identity": {
        "name": "Moltbot",
        "soul": "You are a helpful AI assistant.",
        "boot": "Always respond in Traditional Chinese.",
        "user": "User: Developer"
      },
      
      // 工具配置
      "tools": {
        "exec": {
          "enabled": true,
          "allowedCommands": ["ls", "cat", "grep"],
          "deniedCommands": ["rm -rf", "sudo"]
        },
        "browser": {
          "enabled": true,
          "headless": true
        },
        "node": {
          "enabled": true
        }
      },
      
      // 鉤子
      "hooks": {
        "beforeReply": "hooks/before-reply.js",
        "afterReply": "hooks/after-reply.js"
      }
    },
    
    // 自訂 Agent
    "code-expert": {
      "id": "code-expert",
      "name": "Code Expert",
      "model": "claude-sonnet",
      "identity": {
        "soul": "You are an expert programmer specialized in TypeScript."
      }
    }
  }
}
```

### channels - 頻道配置

```json5
{
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "${TELEGRAM_BOT_TOKEN}",
      "allowlist": ["@user1", "@user2", "123456789"],
      "webhook": {
        "enabled": false,
        "url": "https://example.com/webhook/telegram"
      }
    },
    
    "whatsapp": {
      "enabled": true,
      "allowlist": ["+1234567890"],
      "qrTimeout": 60000
    },
    
    "discord": {
      "enabled": true,
      "token": "${DISCORD_BOT_TOKEN}",
      "allowlist": ["user#1234", "server_id"]
    },
    
    "slack": {
      "enabled": true,
      "token": "${SLACK_BOT_TOKEN}",
      "signingSecret": "${SLACK_SIGNING_SECRET}",
      "appToken": "${SLACK_APP_TOKEN}"
    },
    
    "signal": {
      "enabled": true,
      "number": "+1234567890",
      "apiUrl": "http://localhost:8080"
    },
    
    "imessage": {
      "enabled": true,
      "allowlist": ["+1234567890", "user@icloud.com"]
    }
  }
}
```

### gateway - Gateway 配置

```json5
{
  "gateway": {
    "mode": "local",           // local | remote
    "port": 18789,
    "bind": "loopback",        // loopback | lan | 0.0.0.0
    "token": "${GATEWAY_TOKEN}",
    
    // TLS 設定
    "tls": {
      "enabled": false,
      "cert": "/path/to/cert.pem",
      "key": "/path/to/key.pem"
    },
    
    // CORS 設定
    "cors": {
      "enabled": true,
      "origins": ["http://localhost:*"]
    }
  }
}
```

### routing - 路由配置

```json5
{
  "routing": {
    "rules": [
      {
        "match": {
          "channel": "telegram",
          "chat": "@admin"
        },
        "agent": "admin-agent"
      },
      {
        "match": {
          "channel": "*",
          "pattern": "^/code"
        },
        "agent": "code-expert"
      }
    ],
    "default": "default"
  }
}
```

## 特殊功能

### 環境變數替換

```json5
{
  "providers": {
    "anthropic": {
      // ${VAR} 會被環境變數替換
      "apiKey": "${ANTHROPIC_API_KEY}"
    }
  }
}
```

### $include 指令

```json5
{
  // 包含其他配置檔案
  "$include": ["./providers.json5", "./agents.json5"],
  
  "models": {
    "default": "claude-sonnet"
  }
}
```

### 註解

JSON5 支援 JavaScript 風格的註解：

```json5
{
  // 這是單行註解
  "key": "value",
  
  /* 
   * 這是多行註解
   */
  "another": "value"
}
```

## 配置載入流程

```
1. 解析候選路徑
   - 環境變數 CLAWDBOT_CONFIG_PATH
   - Profile 檔案 ~/.clawdbot/config.{profile}.json5
   - 預設檔案 ~/.clawdbot/config.json5

2. 讀取 JSON5 檔案
   ↓
3. 解析 $include 指令
   - 遞迴載入包含的檔案
   - 合併配置
   ↓
4. 環境變數替換
   - 替換 ${VAR} 為實際值
   ↓
5. Zod Schema 驗證
   - 檢查必要欄位
   - 驗證類型和格式
   ↓
6. 應用預設值
   - applyModelDefaults
   - applyAgentDefaults
   - applyChannelDefaults
   ↓
7. 路徑標準化
   - 展開 ~ 為使用者目錄
   - 轉換相對路徑為絕對路徑
   ↓
8. 快取（可選）
   - 根據 CLAWDBOT_CONFIG_CACHE_MS 設定
```

## CLI 配置管理

### 查看配置

```bash
# 列出所有配置
moltbot config list

# 取得特定配置
moltbot config get models.default
moltbot config get channels.telegram.enabled
```

### 設定配置

```bash
# 設定值
moltbot config set models.default gpt-4o
moltbot config set channels.telegram.enabled true

# 設定 JSON 值
moltbot config set agents.default.tools '{"exec":{"enabled":true}}'
```

### 編輯配置

```bash
# 用預設編輯器開啟
moltbot config edit

# 指定編輯器
EDITOR=code moltbot config edit
```

### 重新載入

```bash
# Gateway 重新載入配置
moltbot config reload
```

## 驗證與除錯

### 驗證配置

```bash
# 檢查配置有效性
moltbot config validate

# 顯示解析後的完整配置
moltbot config dump
```

### 除錯模式

```bash
# 啟用配置載入除錯
CLAWDBOT_DEBUG=config moltbot config list
```

## 安全建議

1. **不要在配置中硬編碼敏感資訊**
   - 使用環境變數 `${VAR}`
   - 或使用秘密管理工具

2. **限制配置檔案權限**
   ```bash
   chmod 600 ~/.clawdbot/config.json5
   ```

3. **使用 .gitignore 排除配置**
   ```
   # .gitignore
   .clawdbot/config.json5
   .clawdbot/config.*.json5
   ```

4. **定期輪換 Token 和金鑰**

## 配置範本

### 最小配置

```json5
{
  "models": {
    "default": "claude-sonnet",
    "entries": {
      "claude-sonnet": {
        "provider": "anthropic",
        "model": "claude-3-5-sonnet-latest"
      }
    }
  },
  "providers": {
    "anthropic": {
      "apiKey": "${ANTHROPIC_API_KEY}"
    }
  }
}
```

### 完整生產配置

參見 `docs/reference/templates/` 目錄中的範本檔案。
